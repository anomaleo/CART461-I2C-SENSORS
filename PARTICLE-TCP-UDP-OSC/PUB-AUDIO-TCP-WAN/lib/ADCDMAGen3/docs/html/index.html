<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ADCDMAGen3_RK: ADC DMA Gen3</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">ADCDMAGen3_RK
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">ADC DMA Gen3 </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><em>Analog to digital conversion using DMA for Particle Gen 3 devices (Argon, Boron, Xenon)</em></p>
<p><b>Note: This feature is experimental and not supported. It may not work properly. It may break in a future version of Device OS. Beware!</b></p>
<p>Also, this is the preview release 0.0.1, there may still be bugs.</p>
<h2>Introduction</h2>
<p>Normally, on Particle (and Arduino) devices, the <code>analogRead()</code> function reads a value from a pin synchronously. There's a limit to how fast you can do this, and also because of the task scheduling on Particle, it's hard to do this regularly.</p>
<p>The nRF52 MCU in the Particle Argon, Boron, and Xenon has the ability to sample the analog to digital converter (ADC) using DMA (direct memory access). This samples the ADC at precise intervals (even when interrupts are disabled) and stores the values in RAM. You can do this into a single buffer if doing a one-shot sample until the buffer is filled. Or you can use double buffers so the capture is continuous. Once one buffer is filled you can begin processing it while the other buffer continues to be filled.</p>
<p>Some caveats:</p>
<ul>
<li>This is an unsupported feature.</li>
<li>You cannot mix calls to ADC DMA and <code>analogRead()</code> at the same time. In order to <code>analogRead()</code> you must <code>uninit()</code> the ADC DMA.</li>
<li>There are hardware timer limitations. In the examples below, NFC cannot be used at the same time as ADC DMA, but if you absolutely need to use NFC you could give up a different peripheral (like Serial1).</li>
</ul>
<p>You typically create a <code><a class="el" href="class_a_d_c_d_m_a_gen3.html" title="Analog to digital conversion using DMA for Particle Gen 3 devices (Argon, Boron, Xenon) ...">ADCDMAGen3</a></code> object as a global variable. You can only have one per app!</p>
<div class="fragment"><div class="line">#include &quot;ADCDMAGen3_RK.h&quot;</div><div class="line"></div><div class="line">ADCDMAGen3 adc;</div><div class="line"></div><div class="line">const size_t SAMPLE_FREQ = 16000; // Hz</div><div class="line"></div><div class="line">const size_t SAMPLES_IN_BUFFER = 1024;</div><div class="line"></div><div class="line">static nrf_saadc_value_t buffer0[SAMPLES_IN_BUFFER];</div><div class="line">static nrf_saadc_value_t buffer1[SAMPLES_IN_BUFFER];</div></div><!-- fragment --><p>Some constants and two buffers are set up as global variables as well.</p>
<p>You can either set up the settings from <code>setup()</code> or right before you need to use ADC DMA.</p>
<div class="fragment"><div class="line">ret_code_t err = adc</div><div class="line">    .withSampleFreqHz(SAMPLE_FREQ)</div><div class="line">    .withDoubleBuffer(SAMPLES_IN_BUFFER, buffer0, buffer1)</div><div class="line">    .withSamplePin(A0)</div><div class="line">    .withBufferCallback(myBufferCallback)</div><div class="line">    .init();</div></div><!-- fragment --><p>Settings are made fluent-style with the <code>withXXX()</code> methods. In the example above:</p>
<ul>
<li>Sampling frequency is set to <code>SAMPLE_FREQ</code> (16000 Hz)</li>
<li>Double buffering is enabled and stores <code>SAMPLES_IN_BUFFER</code> (1024) samples in each of <code>buffer0</code> and <code>buffer1</code>. When one buffer is filled the bufferCallback is called and the other buffer will continue to be filled. This prevents losing samples while processing a buffer.</li>
<li>Samples pin A0</li>
<li>Sets the bufferCallback to the function <code>myBufferCallback</code>.</li>
<li>Finally calls <code>init()</code> to complete the initialization.</li>
</ul>
<p>You must call <code>init()</code> and <code>start()</code> to actually start sampling.</p>
<p>You can call <code>init()</code> once and use <code>start()</code> and <code>stop()</code> as necessary.</p>
<p>Or you can call <code>init()</code> and <code>start()</code> whenever you want to sample and call <code>uninit()</code> when done. This will release the ADC resources when not actively being used.</p>
<p>If you want to mix ADC DMA and <code>analogRead()</code> you need to call both <code>uninit()</code> and <code>restoreDefaults()</code>. See the 07-mixed example for more information.</p>
<p>The other thing you need to do is set a bufferCallback, the function that's called when a</p>
<p>The bufferCallback function looks like this:</p>
<div class="fragment"><div class="line">void myBufferCallback(nrf_saadc_value_t *buf, size_t size) {</div><div class="line">    // This gets executed after each sample buffer has been read.</div><div class="line">    // Note: This is executed in interrupt context, so beware of what you do here!</div><div class="line"></div><div class="line">    // We just remember the buffer and handle it from loop</div><div class="line">    bufferReady = buf;</div><div class="line">}</div></div><!-- fragment --><p>Because we may want to do lengthy operations we just save the buffer pointer and handle it from loop().</p>
<p>The samples other than 01-simple use a C++11 lambda to handle the buffer callback. That technique can also be used to call a class member function if desired.</p>
<div class="fragment"><div class="line">adc.withBufferCallback([](nrf_saadc_value_t *buf, size_t size) {</div><div class="line">    // This gets executed after each sample buffer has been read.</div><div class="line">    // Note: This is executed in interrupt context, so beware of what you do here!</div><div class="line"></div><div class="line">    // We just remember the buffer and handle it from loop</div><div class="line">    bufferReady = buf;</div><div class="line">});</div></div><!-- fragment --><p>In addition to the SAADC (successive approximation ADC) module in the nRF52, this library also requires a hardware timer. Unfortunately there are no free timers available and you'll have to steal one.</p>
<ul>
<li>0: Softdevice - do not use</li>
<li>1: Radio - probably best to not use, might work if not using BLE or mesh</li>
<li>2: Usart (Serial1) Can use if not using Serial1.</li>
<li>3: Usart (Serial2 on Xenon) Cannot be used on Argon or Boron because it's required by NCP.</li>
<li>4: NFC - recommended (unless you need NFC). This is the default.</li>
</ul>
<p>The default is to use the NFC timer, which means you can't use NFC at the same time. If you need NFC, then you can switch to using a different timer using <code>withHardwareTimer()</code>.</p>
<h2>API documentation</h2>
<h2>Examples</h2>
<h3>01-simple</h3>
<p>This is the simplest example, and the code is described above in the introduction.</p>
<h3>02-audio-over-tcp</h3>
<p>This sends audio data to a node.js server (located in the server directory).</p>
<p>I used an <a href="https://www.adafruit.com/products/1713">Adafruit 1713</a> Electret Microphone Amplifier - MAX9814 with Auto Gain Control. Connect:</p>
<ul>
<li>GND to GND</li>
<li>Vd to 3V3</li>
<li>Gain (leave unconnected)</li>
<li>Out to A0</li>
<li>AR (leave unconnected)</li>
</ul>
<div class="image">
<img src="mic.jpg" alt="mic.jpg"/>
<div class="caption">
Microphone</div></div>
<p> Make sure you update the example code with the IP address and port of your server.</p>
<p>To install the dependencies:</p>
<div class="fragment"><div class="line">cd server</div><div class="line">npm install</div></div><!-- fragment --><p>To run the server:</p>
<div class="fragment"><div class="line">npm start</div></div><!-- fragment --><p>To sample audio, tap the MODE button. It will connect to the server and send audio for 30 seconds, or until you stop it using the MODE button.</p>
<p>The server saves .wav files in the <code>out</code> directory.</p>
<h3>03-one-shot-freq-counter</h3>
<p>This code samples A0 to find the dominant frequency. This is best tested by connecting a function generator to A0. Make sure it's set to a sine wave 0 to 3.3V, not sending negative voltages!</p>
<p>This samples at 200 kHz so it can detect frequencies up to a little less than 100 kHz.</p>
<p>The frequency is printed to USB debug serial. You can read it with a serial terminal program or <code>particle serial monitor</code>.</p>
<h3>04-continuous-freq-counter</h3>
<p>This is a continuous version the frequency counter. When the frequency changes it's printed to the USB debug serial. It's limited to detecting frequencies up to around 24 kHz.</p>
<h3>05-dtmf</h3>
<p>This example listens to the microphone input on A0 and prints any DTMF (telephone keypad) frequencies it hears to USB debug serial.</p>
<h3>06-dtmf-two-channel</h3>
<p>This example shows how to handle sampling multiple pins using the DTMF decoder.</p>
<h3>07-mixed</h3>
<p>This example shows how to switch between ADC DMA and <code>analogRead()</code> mode. Basically, make sure you call:</p>
<div class="fragment"><div class="line">adc.uninit();</div><div class="line">adc.restoreDefaults();</div></div><!-- fragment --><p>after using ADC DMA and before using <code>analogRead()</code> again. Then call <code>adc.init()</code> again if you want to use ADC DMA again. You don't need to reset the settings using the <code>withXXX()</code> methods again; they are saved.</p>
<h2>More Examples</h2>
<p>The more-examples directory contains more examples, mainly based on the SSD1306 display.</p>
<h3>more-examples/01-dtmf-display</h3>
<p>Works like the 05-dtmf example, but displays the results on a 0.96" OLED SSD1306 display.</p>
<p>&lt;video width="640" height="360" controls=""&gt; &lt;source src="images/dtmf.mp4" type="video/mp4"&gt; &lt;/video&gt;</p>
<h3>more-examples/02-spectrum</h3>
<p>Based on the 04-continuous-freq-counter example, instead of picking the dominant frequency it displays the results on a SSD1306 display showing the amplitude on each frequency bucket.</p>
<p>I'm not completely sure the results are correct, however it does display something, and does update at 20 millisecond intervals, which is pretty impressive, in my opinion.</p>
<h3>more-examples/03-frequency-counter</h3>
<p>A slightly modified version of 04-continuous-freq-counter that samples at 200 kHz and displays the results on a SSD1306 display.</p>
<p>It's pretty close (97000 vs. 97070 Hz.)!</p>
<div class="image">
<img src="freq.jpg" alt="freq.jpg"/>
<div class="caption">
Frequency Counter</div></div>
 <h2>Version History</h2>
<ul>
<li>0.0.1 (2019-09-27) Initial version. There may be bugs still. </li>
</ul>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
